<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance BI Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #111827;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sidebar-width: 250px;
        }

        .dark-mode {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { background-color: var(--bg-body); color: var(--text-main); transition: background 0.3s, color 0.3s; display: flex; height: 100vh; overflow: hidden; }

        /* --- Navigation --- */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            height: 100vh;
            position: fixed;
            left: 0; top: 0;
            z-index: 50;
            transition: transform 0.3s;
        }

        .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        
        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 500;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
        }
        .nav-item:hover, .nav-item.active { background-color: var(--primary); color: white; }
        
        .theme-toggle { margin-top: auto; cursor: pointer; padding: 10px; border: 1px solid var(--border); border-radius: 8px; text-align: center; }

        /* Bottom Nav (Mobile) */
        #bottom-nav { display: none; position: fixed; bottom: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); padding: 10px; justify-content: space-around; z-index: 100; }
        
        /* --- Main Content --- */
        #main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            position: relative;
            padding-bottom: 80px; /* Space for mobile nav */
        }

        /* --- Filter Bar --- */
        .filter-bar {
            position: sticky; top: 0;
            background-color: var(--bg-card);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            z-index: 40;
            display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        select, .btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-body);
            color: var(--text-main);
            outline: none;
            cursor: pointer;
        }
        
        .btn { background: var(--primary); color: white; border: none; font-weight: 600; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); }
        
        /* Filter Chips */
        #active-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-left: auto; }
        .chip { background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
        .chip i { cursor: pointer; }

        /* --- Pages --- */
        .page { display: none; padding: 2rem; animation: fadeIn 0.4s; }
        .page.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard Grid --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-card { background: var(--bg-card); padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .kpi-title { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; }
        .kpi-sub { font-size: 0.8rem; color: var(--success); margin-top: 5px; }

        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem; }
        .chart-card { background: var(--bg-card); padding: 1rem; border-radius: 12px; box-shadow: var(--shadow); height: 400px; }
        .chart-full { grid-column: span 2; }

        /* --- Add Transaction --- */
        .form-container { max-width: 600px; margin: 0 auto; background: var(--bg-card); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-main); }
        
        .tx-table { width: 100%; border-collapse: collapse; margin-top: 2rem; background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        .tx-table th, .tx-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        .tx-table th { background-color: var(--bg-body); font-weight: 600; }

        /* --- Settings --- */
        .settings-card { max-width: 600px; background: var(--bg-card); padding: 2rem; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 1rem; }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            #sidebar { display: none; }
            #bottom-nav { display: flex; }
            #main-content { margin-left: 0; padding-bottom: 80px; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-full { grid-column: span 1; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            #active-filters { margin-left: 0; }
        }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="logo"><i class="fas fa-chart-pie"></i> FinDash</div>
        <div class="nav-item active" onclick="switchPage('dashboard')"><i class="fas fa-home"></i> Dashboard</div>
        <div class="nav-item" onclick="switchPage('add')"><i class="fas fa-plus-circle"></i> Add Transaction</div>
        <div class="nav-item" onclick="switchPage('settings')"><i class="fas fa-cog"></i> Settings</div>
        
        <div class="theme-toggle" onclick="toggleTheme()">
            <i class="fas fa-moon"></i> Toggle Dark Mode
        </div>
    </nav>

    <main id="main-content">
        
        <div class="filter-bar" id="dashboard-filters">
            <select id="filter-month" onchange="applyFilters()"><option value="all">All Months</option></select>
            <select id="filter-type" onchange="applyFilters()">
                <option value="all">All Types</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
            </select>
            <select id="filter-category" onchange="applyFilters()"><option value="all">All Categories</option></select>
            
            <div id="active-filters"></div>
            
            <button class="btn btn-outline" onclick="resetFilters()" title="Clear Visual Filters"><i class="fas fa-undo"></i></button>
            <button class="btn btn-outline" onclick="exportPDF()" title="Export PDF"><i class="fas fa-file-pdf"></i></button>
        </div>

        <div id="dashboard" class="page active">
            <div id="dashboard-content">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">Total Income</div>
                        <div class="kpi-value text-success" id="kpi-income">$0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Total Expense</div>
                        <div class="kpi-value text-danger" id="kpi-expense">$0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Net Savings</div>
                        <div class="kpi-value" id="kpi-savings">$0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">Budget Used</div>
                        <div class="kpi-value" id="kpi-budget">0%</div>
                        <div class="kpi-sub" id="kpi-budget-val">of target</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card chart-full" id="chart-trend"></div>
                    <div class="chart-card" id="chart-budget-actual"></div>
                    <div class="chart-card" id="chart-category"></div>
                    <div class="chart-card" id="chart-bar-top"></div>
                    <div class="chart-card" id="chart-savings-area"></div>
                    <div class="chart-card" id="chart-weekday"></div>
                </div>
            </div>
        </div>

        <div id="add" class="page">
            <div class="form-container">
                <h2>Add Transaction</h2>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="tx-date">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="tx-type">
                        <option value="Expense">Expense</option>
                        <option value="Income">Income</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="tx-category" list="category-list" placeholder="e.g., Food, Salary">
                    <datalist id="category-list">
                        <option value="Food"><option value="Transport"><option value="Salary"><option value="Rent"><option value="Entertainment">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>Amount</label>
                    <input type="number" id="tx-amount" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Note</label>
                    <input type="text" id="tx-note" placeholder="Optional description">
                </div>
                <button class="btn" style="width:100%" onclick="addTransaction()">Add Transaction</button>
            </div>

            <div style="margin-top: 2rem; display:flex; gap:10px; justify-content:center;">
                <button class="btn" onclick="generateDemoData()">Generate 60-Day Demo Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">Reset Data</button>
            </div>

            <h3 style="margin-top: 2rem;">Recent Transactions</h3>
            <table class="tx-table">
                <thead><tr><th>Date</th><th>Category</th><th>Type</th><th>Amount</th></tr></thead>
                <tbody id="tx-list-body"></tbody>
            </table>
            <button class="btn btn-outline" style="margin-top:1rem" onclick="downloadCSV()">Download CSV</button>
        </div>

        <div id="settings" class="page">
            <div class="settings-card">
                <h2>Settings</h2>
                <div class="form-group">
                    <label>Currency Symbol</label>
                    <select id="set-currency" onchange="saveSettings()">
                        <option value="$">$ (USD)</option>
                        <option value="€">€ (EUR)</option>
                        <option value="£">£ (GBP)</option>
                        <option value="₫">₫ (VND)</option>
                        <option value="¥">¥ (JPY)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monthly Budget Limit</label>
                    <input type="number" id="set-budget" onchange="saveSettings()" value="2000">
                </div>
            </div>
        </div>

    </main>

    <div id="bottom-nav">
        <div class="nav-item active" onclick="switchPage('dashboard')"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="switchPage('add')"><i class="fas fa-plus-circle"></i></div>
        <div class="nav-item" onclick="switchPage('settings')"><i class="fas fa-cog"></i></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmV3I9ZQ-N866cZ5mzMhVLNHcKjfL8cQ0",
            authDomain: "financial-tracking-app-bb3cb.firebaseapp.com",
            databaseURL: "https://financial-tracking-app-bb3cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "financial-tracking-app-bb3cb",
            storageBucket: "financial-tracking-app-bb3cb.firebasestorage.app",
            messagingSenderId: "242060161334",
            appId: "1:242060161334:web:e9a4e0c7f8758cd9770397",
            measurementId: "G-NV4B6CWRBS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dbRef = ref(db, 'transactions');

        // --- State Management ---
        let appState = {
            transactions: [],
            settings: { currency: '$', budget: 2000 },
            filters: { month: 'all', type: 'all', category: 'all' },
            visualFilters: { category: null, dateRange: null } // Cross-filtering
        };

        // --- Data Loading ---
        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            appState.transactions = data ? Object.values(data) : [];
            updateUI();
        });

        // Load Settings from LocalStorage (User preference specific)
        const savedSettings = localStorage.getItem('finSettings');
        if(savedSettings) appState.settings = JSON.parse(savedSettings);
        document.getElementById('set-currency').value = appState.settings.currency;
        document.getElementById('set-budget').value = appState.settings.budget;

        // --- Global Functions (Exposed to Window) ---
        window.switchPage = (pageId) => {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            // Highlight Nav
            const navIndex = ['dashboard', 'add', 'settings'].indexOf(pageId);
            if(navIndex > -1) {
                document.querySelectorAll('#sidebar .nav-item')[navIndex].classList.add('active');
                document.querySelectorAll('#bottom-nav .nav-item')[navIndex].classList.add('active');
            }
            
            // Resize charts if dashboard
            if(pageId === 'dashboard') {
                setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            }
        };

        window.toggleTheme = () => {
            document.body.classList.toggle('dark-mode');
            updateChartsTheme();
        };

        window.saveSettings = () => {
            appState.settings.currency = document.getElementById('set-currency').value;
            appState.settings.budget = parseFloat(document.getElementById('set-budget').value) || 0;
            localStorage.setItem('finSettings', JSON.stringify(appState.settings));
            updateUI();
        };

        window.addTransaction = () => {
            const date = document.getElementById('tx-date').value;
            const type = document.getElementById('tx-type').value;
            const category = document.getElementById('tx-category').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const note = document.getElementById('tx-note').value;

            if(!date || !amount || !category) return alert("Please fill required fields");

            push(dbRef, { date, type, category, amount, note });
            alert("Transaction Added");
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-note').value = '';
        };

        window.generateDemoData = () => {
            const categories = { 'Expense': ['Food', 'Rent', 'Transport', 'Entertainment', 'Bills'], 'Income': ['Salary', 'Freelance', 'Investments'] };
            const batch = {};
            for(let i=0; i<30; i++) {
                const type = Math.random() > 0.3 ? 'Expense' : 'Income';
                const cats = categories[type];
                const cat = cats[Math.floor(Math.random() * cats.length)];
                const amt = type === 'Income' ? Math.floor(Math.random() * 2000) + 1000 : Math.floor(Math.random() * 100) + 10;
                const d = new Date();
                d.setDate(d.getDate() - Math.floor(Math.random() * 60));
                
                push(dbRef, {
                    date: d.toISOString().split('T')[0],
                    type: type,
                    category: cat,
                    amount: amt,
                    note: 'Demo Data'
                });
            }
        };

        window.clearAllData = () => {
            if(confirm("Delete all data?")) set(dbRef, null);
        };

        window.applyFilters = () => {
            appState.filters.month = document.getElementById('filter-month').value;
            appState.filters.type = document.getElementById('filter-type').value;
            appState.filters.category = document.getElementById('filter-category').value;
            renderDashboard();
        };

        window.resetFilters = () => {
            appState.visualFilters = { category: null, dateRange: null };
            document.getElementById('filter-month').value = 'all';
            document.getElementById('filter-type').value = 'all';
            document.getElementById('filter-category').value = 'all';
            applyFilters();
        };
        
        window.downloadCSV = () => {
            let csv = "Date,Type,Category,Amount,Note\n";
            appState.transactions.forEach(tx => {
                csv += `${tx.date},${tx.type},${tx.category},${tx.amount},${tx.note}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'transactions.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        window.exportPDF = () => {
            const element = document.getElementById('dashboard-content');
            html2canvas(element, { scale: 2, backgroundColor: document.body.classList.contains('dark-mode') ? '#111827' : '#f3f4f6' }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save("dashboard.pdf");
            });
        };

        // --- UI Updates ---
        function updateUI() {
            populateFilterDropdowns();
            renderTransactionsList();
            renderDashboard();
        }

        function getFilteredData() {
            return appState.transactions.filter(tx => {
                const txDate = new Date(tx.date);
                const monthKey = `${txDate.getFullYear()}-${String(txDate.getMonth()+1).padStart(2,'0')}`;
                
                // Global Dropdown Filters
                const matchMonth = appState.filters.month === 'all' || monthKey === appState.filters.month;
                const matchType = appState.filters.type === 'all' || tx.type === appState.filters.type;
                const matchCat = appState.filters.category === 'all' || tx.category === appState.filters.category;
                
                // Visual Interaction Filters (Cross-Filtering)
                const matchVisualCat = !appState.visualFilters.category || tx.category === appState.visualFilters.category;
                const matchVisualDate = !appState.visualFilters.dateRange || (tx.date >= appState.visualFilters.dateRange[0] && tx.date <= appState.visualFilters.dateRange[1]);

                return matchMonth && matchType && matchCat && matchVisualCat && matchVisualDate;
            });
        }

        function populateFilterDropdowns() {
            const months = new Set();
            const categories = new Set();
            appState.transactions.forEach(tx => {
                months.add(tx.date.substring(0, 7)); // YYYY-MM
                categories.add(tx.category);
            });

            const monthSel = document.getElementById('filter-month');
            const catSel = document.getElementById('filter-category');
            
            // Preserve current selection if exists
            const currMonth = monthSel.value;
            const currCat = catSel.value;

            // Clear (keep first option)
            while(monthSel.options.length > 1) monthSel.remove(1);
            while(catSel.options.length > 1) catSel.remove(1);

            Array.from(months).sort().reverse().forEach(m => {
                const opt = new Option(m, m);
                monthSel.add(opt);
            });
            Array.from(categories).sort().forEach(c => {
                const opt = new Option(c, c);
                catSel.add(opt);
            });

            monthSel.value = currMonth;
            catSel.value = currCat;
        }

        function renderTransactionsList() {
            const tbody = document.getElementById('tx-list-body');
            tbody.innerHTML = '';
            // Sort by date desc, take top 10
            const sorted = [...appState.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            
            sorted.forEach(tx => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tx.date}</td>
                    <td>${tx.category}</td>
                    <td style="color: ${tx.type==='Income'? 'var(--success)' : 'var(--danger)'}">${tx.type}</td>
                    <td>${appState.settings.currency}${tx.amount.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- DASHBOARD RENDERER (PLOTLY) ---
        function renderDashboard() {
            const data = getFilteredData();
            const cur = appState.settings.currency;
            const isDark = document.body.classList.contains('dark-mode');
            
            // Layout Defaults
            const layoutCommon = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: isDark ? '#f9fafb' : '#111827' },
                margin: { t: 40, b: 40, l: 40, r: 20 },
                showlegend: true
            };

            // 1. KPIs
            const totalInc = data.filter(d => d.type === 'Income').reduce((s, d) => s + d.amount, 0);
            const totalExp = data.filter(d => d.type === 'Expense').reduce((s, d) => s + d.amount, 0);
            const savings = totalInc - totalExp;
            
            document.getElementById('kpi-income').innerText = `${cur}${totalInc.toLocaleString()}`;
            document.getElementById('kpi-expense').innerText = `${cur}${totalExp.toLocaleString()}`;
            document.getElementById('kpi-savings').innerText = `${cur}${savings.toLocaleString()}`;
            
            const budgetPct = appState.settings.budget > 0 ? (totalExp / appState.settings.budget) * 100 : 0;
            document.getElementById('kpi-budget').innerText = `${budgetPct.toFixed(1)}%`;

            // Update Filter Chips
            const chipContainer = document.getElementById('active-filters');
            chipContainer.innerHTML = '';
            if(appState.visualFilters.category) chipContainer.innerHTML += `<span class="chip">${appState.visualFilters.category} <i class="fas fa-times" onclick="window.clearVisualFilter('cat')"></i></span>`;
            if(appState.visualFilters.dateRange) chipContainer.innerHTML += `<span class="chip">Date Range <i class="fas fa-times" onclick="window.clearVisualFilter('date')"></i></span>`;

            // 2. Line Trend (Income vs Expense)
            // Group by Date
            const dateMap = {};
            data.forEach(tx => {
                if(!dateMap[tx.date]) dateMap[tx.date] = { income: 0, expense: 0 };
                if(tx.type === 'Income') dateMap[tx.date].income += tx.amount;
                else dateMap[tx.date].expense += tx.amount;
            });
            const sortedDates = Object.keys(dateMap).sort();
            
            Plotly.newPlot('chart-trend', [
                { x: sortedDates, y: sortedDates.map(d => dateMap[d].income), type: 'scatter', mode: 'lines+markers', name: 'Income', line: {color: '#10b981'} },
                { x: sortedDates, y: sortedDates.map(d => dateMap[d].expense), type: 'scatter', mode: 'lines+markers', name: 'Expense', line: {color: '#ef4444'} }
            ], { ...layoutCommon, title: 'Income vs Expense Trend', dragmode: 'select' }, {responsive: true})
            .then(gd => {
                gd.on('plotly_selected', (eventData) => {
                    if (eventData && eventData.range) {
                        appState.visualFilters.dateRange = eventData.range.x;
                        updateUI(); // Recursive render with filter
                    }
                });
            });

            // 3. Budget vs Actual (Expense Cumulative)
            let cumExp = 0;
            const cumExpArr = sortedDates.map(d => {
                cumExp += dateMap[d].expense;
                return cumExp;
            });
            // Simple straight line for budget (approximation)
            const dailyBudget = appState.settings.budget / 30; // Rough daily
            const budgetLine = sortedDates.map((_, i) => (i+1) * dailyBudget);

            Plotly.newPlot('chart-budget-actual', [
                { x: sortedDates, y: cumExpArr, type: 'scatter', fill: 'tozeroy', name: 'Actual Cumulative', line: {color: '#6366f1'} },
                { x: sortedDates, y: budgetLine, type: 'scatter', mode: 'lines', name: 'Budget Pace', line: {dash: 'dot', color: '#9ca3af'} }
            ], { ...layoutCommon, title: 'Budget vs Actual (Cumulative)' }, {responsive: true});

            // 4. Donut: Expense by Category
            const expByCat = {};
            data.filter(d => d.type === 'Expense').forEach(d => {
                expByCat[d.category] = (expByCat[d.category] || 0) + d.amount;
            });
            
            Plotly.newPlot('chart-category', [{
                labels: Object.keys(expByCat),
                values: Object.values(expByCat),
                type: 'pie', hole: 0.4,
                marker: { colors: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }
            }], { ...layoutCommon, title: 'Expense by Category' }, {responsive: true})
            .then(gd => {
                gd.on('plotly_click', (data) => {
                    appState.visualFilters.category = data.points[0].label;
                    updateUI();
                });
            });

            // 5. Bar: Top Categories (Budget vs Actual - faked budget for categories as 120% of avg)
            const sortedCats = Object.keys(expByCat).sort((a,b) => expByCat[b] - expByCat[a]).slice(0, 5);
            Plotly.newPlot('chart-bar-top', [{
                x: sortedCats.map(c => expByCat[c]),
                y: sortedCats,
                type: 'bar', orientation: 'h',
                marker: { color: '#6366f1' }
            }], { ...layoutCommon, title: 'Top Expense Categories', margin: {l: 100} }, {responsive: true})
            .then(gd => {
                gd.on('plotly_click', (data) => {
                    appState.visualFilters.category = data.points[0].label;
                    updateUI();
                });
            });

            // 6. Area: Daily Net Savings
            Plotly.newPlot('chart-savings-area', [{
                x: sortedDates,
                y: sortedDates.map(d => dateMap[d].income - dateMap[d].expense),
                type: 'scatter', fill: 'tozeroy',
                line: { color: '#10b981' }
            }], { ...layoutCommon, title: 'Daily Net Savings' }, {responsive: true});

            // 7. Weekday vs Weekend (Donut)
            let weekend = 0, weekday = 0;
            data.filter(d => d.type === 'Expense').forEach(d => {
                const day = new Date(d.date).getDay();
                if(day === 0 || day === 6) weekend += d.amount;
                else weekday += d.amount;
            });
            Plotly.newPlot('chart-weekday', [{
                labels: ['Weekday', 'Weekend'],
                values: [weekday, weekend],
                type: 'pie', hole: 0.6,
                marker: { colors: ['#3b82f6', '#f97316'] }
            }], { ...layoutCommon, title: 'Weekday vs Weekend Spending' }, {responsive: true});
        }

        // Helper for clearing chips
        window.clearVisualFilter = (type) => {
            if(type === 'cat') appState.visualFilters.category = null;
            if(type === 'date') appState.visualFilters.dateRange = null;
            updateUI();
        };

        function updateChartsTheme() {
            renderDashboard();
        }

        // Set default date
        document.getElementById('tx-date').valueAsDate = new Date();
    </script>
</body>
</html>
