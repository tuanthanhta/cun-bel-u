<!DOCTYPE html>
<html lang="vi" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WealthPulse | Connected Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#3B82F6', 600: '#2563EB', 900: '#1E3A8A' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .light .glass { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .chart-container { width: 100%; min-height: 300px; }
        /* Transition cho Dark mode toggle */
        body { transition: background-color 0.3s, color 0.3s; }
        [v-cloak] { display: none; }
    </style>
</head>

<body class="bg-gray-100 text-slate-800 dark:bg-dark-900 dark:text-slate-200 h-screen overflow-hidden font-sans">

    <div id="app" v-cloak class="h-full flex flex-col">

        <div v-if="!user" class="fixed inset-0 z-50 flex items-center justify-center bg-[url('https://images.unsplash.com/photo-1639322537228-f710d846310a?w=1920&q=80')] bg-cover bg-center">
            <div class="absolute inset-0 bg-dark-900/90 backdrop-blur-md"></div>
            <div class="relative z-10 glass p-8 rounded-2xl max-w-md w-full text-center shadow-2xl mx-4">
                <div class="w-16 h-16 bg-gradient-to-tr from-brand-500 to-cyan-400 rounded-xl mx-auto flex items-center justify-center mb-6 shadow-lg shadow-brand-500/30">
                    <i data-lucide="activity" class="text-white w-8 h-8"></i>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">WealthPulse</h1>
                <p class="text-slate-400 mb-8">Dashboard t√†i ch√≠nh th√¥ng minh<br>ƒê·ªìng b·ªô Cloud - Ph√¢n t√≠ch chuy√™n s√¢u</p>
                <button @click="login" class="w-full bg-white hover:bg-gray-50 text-slate-900 font-bold py-3.5 rounded-xl flex items-center justify-center gap-3 transition-transform hover:scale-[1.02] shadow-xl">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6">
                    <span>ƒêƒÉng nh·∫≠p v·ªõi Google</span>
                </button>
            </div>
        </div>

        <div v-else class="flex h-full">
            
            <aside class="hidden md:flex w-64 flex-col glass border-r border-slate-200 dark:border-white/5 z-20">
                <div class="p-6 flex items-center gap-3">
                    <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white"><i data-lucide="pie-chart" class="w-5 h-5"></i></div>
                    <span class="font-bold text-lg tracking-tight">WealthPulse</span>
                </div>
                <nav class="flex-1 px-4 space-y-2 mt-2">
                    <button v-for="page in pages" :key="page.id" @click="currentPage = page.id" 
                        :class="['w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all font-medium', currentPage === page.id ? 'bg-brand-600 text-white shadow-lg shadow-brand-500/20' : 'text-slate-500 dark:text-slate-400 hover:bg-black/5 dark:hover:bg-white/5']">
                        <i :data-lucide="page.icon" class="w-5 h-5"></i> {{ page.label }}
                    </button>
                </nav>
                
                <div class="p-4 border-t border-slate-200 dark:border-white/5 space-y-3">
                    <button @click="toggleTheme" class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-slate-200 dark:bg-slate-800 text-sm">
                        <span>{{ isDark ? 'Dark Mode' : 'Light Mode' }}</span>
                        <i :data-lucide="isDark ? 'moon' : 'sun'" class="w-4 h-4"></i>
                    </button>
                    <div class="flex items-center gap-3 px-1">
                        <img :src="user.photoURL" class="w-8 h-8 rounded-full border border-slate-400">
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-bold truncate">{{ user.displayName }}</p>
                            <button @click="logout" class="text-xs text-red-500 hover:underline">ƒêƒÉng xu·∫•t</button>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="flex-1 flex flex-col h-full overflow-hidden relative">
                
                <header class="md:hidden h-14 glass border-b border-white/5 flex items-center justify-between px-4 z-30 shrink-0">
                    <span class="font-bold text-lg">WealthPulse</span>
                    <button @click="toggleTheme" class="p-2"><i :data-lucide="isDark ? 'moon' : 'sun'" class="w-5 h-5"></i></button>
                </header>

                <div class="flex-1 overflow-y-auto p-4 md:p-6 pb-24 md:pb-6 scroll-smooth" id="main-view">
                    
                    <div v-if="currentPage === 'dashboard'" class="space-y-6">
                        
                        <div class="sticky top-0 z-20 glass rounded-xl p-3 mb-6 flex flex-wrap items-center gap-3 shadow-sm border border-slate-200 dark:border-white/5 backdrop-blur-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="filter" class="w-4 h-4 text-brand-500"></i>
                                <select v-model="filters.month" class="bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg px-2 py-1 text-sm outline-none focus:border-brand-500">
                                    <option value="all">T·∫•t c·∫£ th√°ng</option>
                                    <option v-for="m in availableMonths" :value="m">{{ m }}</option>
                                </select>
                                <select v-model="filters.type" class="bg-transparent border border-slate-300 dark:border-slate-700 rounded-lg px-2 py-1 text-sm outline-none focus:border-brand-500">
                                    <option value="all">T·∫•t c·∫£ lo·∫°i</option>
                                    <option value="income">Thu nh·∫≠p</option>
                                    <option value="expense">Chi ti√™u</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center gap-2 flex-wrap">
                                <span v-if="filters.visualCategory" class="text-xs bg-brand-500/20 text-brand-600 dark:text-brand-300 px-2 py-1 rounded-full flex items-center gap-1 border border-brand-500/30">
                                    Danh m·ª•c: {{ filters.visualCategory }} 
                                    <button @click="filters.visualCategory = null"><i data-lucide="x" class="w-3 h-3"></i></button>
                                </span>
                                <span v-if="filters.dateRange" class="text-xs bg-brand-500/20 text-brand-600 dark:text-brand-300 px-2 py-1 rounded-full flex items-center gap-1 border border-brand-500/30">
                                    Kho·∫£ng ng√†y: {{ formatDateShort(filters.dateRange[0]) }} - {{ formatDateShort(filters.dateRange[1]) }}
                                    <button @click="filters.dateRange = null"><i data-lucide="x" class="w-3 h-3"></i></button>
                                </span>
                                <button v-if="filters.visualCategory || filters.dateRange" @click="resetVisualFilters" class="text-xs text-red-500 hover:underline ml-2">X√≥a b·ªô l·ªçc visual</button>
                            </div>

                            <div class="ml-auto flex gap-2">
                                <button @click="downloadCSV" class="p-2 text-slate-500 hover:text-brand-500" title="T·∫£i CSV"><i data-lucide="download" class="w-5 h-5"></i></button>
                                <button @click="exportPDF" class="p-2 text-slate-500 hover:text-brand-500" title="Xu·∫•t PDF"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="glass p-4 rounded-xl border-l-4 border-green-500">
                                <p class="text-xs text-slate-500 uppercase font-bold">T·ªïng Thu</p>
                                <h3 class="text-xl md:text-2xl font-bold mt-1">{{ formatMoney(kpi.income) }}</h3>
                            </div>
                            <div class="glass p-4 rounded-xl border-l-4 border-red-500">
                                <p class="text-xs text-slate-500 uppercase font-bold">T·ªïng Chi</p>
                                <h3 class="text-xl md:text-2xl font-bold mt-1">{{ formatMoney(kpi.expense) }}</h3>
                            </div>
                            <div class="glass p-4 rounded-xl border-l-4 border-brand-500">
                                <p class="text-xs text-slate-500 uppercase font-bold">Ti·∫øt Ki·ªám R√≤ng</p>
                                <h3 :class="['text-xl md:text-2xl font-bold mt-1', kpi.savings >= 0 ? 'text-brand-500' : 'text-red-500']">{{ formatMoney(kpi.savings) }}</h3>
                            </div>
                            <div class="glass p-4 rounded-xl border-l-4 border-purple-500">
                                <p class="text-xs text-slate-500 uppercase font-bold">% Ng√¢n S√°ch</p>
                                <div class="flex justify-between items-end mt-1">
                                    <h3 class="text-xl md:text-2xl font-bold">{{ kpi.budgetUsed }}%</h3>
                                    <span class="text-xs text-slate-400">/ {{ formatMoney(settings.monthlyBudget) }}</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 h-1 mt-2 rounded-full overflow-hidden">
                                    <div class="bg-purple-500 h-full" :style="{width: Math.min(kpi.budgetUsed, 100) + '%'}"></div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                            
                            <div class="xl:col-span-2 glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="trending-up" class="w-4 h-4 text-brand-500"></i> Xu h∆∞·ªõng Thu/Chi</h4>
                                <div id="chart-trend" class="chart-container"></div>
                                <p class="text-center text-xs text-slate-400 mt-1 italic">üí° K√©o chu·ªôt tr√™n bi·ªÉu ƒë·ªì ƒë·ªÉ l·ªçc theo kho·∫£ng ng√†y</p>
                            </div>

                            <div class="glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="target" class="w-4 h-4 text-purple-500"></i> Th·ª±c t·∫ø vs Ng√¢n s√°ch (T√≠ch l≈©y)</h4>
                                <div id="chart-budget" class="chart-container"></div>
                            </div>

                            <div class="glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4 text-red-500"></i> Ph√¢n b·ªï Chi ti√™u</h4>
                                <div id="chart-category" class="chart-container"></div>
                                <p class="text-center text-xs text-slate-400 mt-1 italic">üí° B·∫•m v√†o mi·∫øng b√°nh ƒë·ªÉ l·ªçc c√°c bi·ªÉu ƒë·ªì kh√°c</p>
                            </div>

                            <div class="glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-orange-500"></i> Top Danh m·ª•c vs ƒê·ªãnh m·ª©c</h4>
                                <div id="chart-top-cat" class="chart-container"></div>
                            </div>

                            <div class="glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-green-500"></i> Ti·∫øt ki·ªám H√†ng ng√†y</h4>
                                <div id="chart-area-savings" class="chart-container"></div>
                            </div>

                            <div class="glass p-4 rounded-xl shadow-lg">
                                <h4 class="font-bold mb-2 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i> Cu·ªëi tu·∫ßn vs Trong tu·∫ßn</h4>
                                <div id="chart-weekend" class="chart-container"></div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentPage === 'add'" class="max-w-4xl mx-auto space-y-6 animate-fade-in">
                        <div class="glass p-6 rounded-xl border border-brand-500/30 shadow-lg">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="plus-circle" class="text-brand-500"></i> Th√™m Giao D·ªãch</h2>
                            <form @submit.prevent="addTransaction" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <div class="relative">
                                        <span class="absolute left-4 top-3.5 text-brand-500 font-bold text-lg">{{ settings.currency }}</span>
                                        <input v-model.number="form.amount" type="number" placeholder="0" required class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-xl py-3 pl-10 pr-4 text-2xl font-bold outline-none focus:ring-2 focus:ring-brand-500">
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" @click="form.type='expense'" :class="['flex-1 py-2 rounded-lg font-medium border transition', form.type==='expense' ? 'bg-red-500/10 text-red-500 border-red-500' : 'border-slate-300 dark:border-slate-700 text-slate-500']">Chi ti√™u</button>
                                    <button type="button" @click="form.type='income'" :class="['flex-1 py-2 rounded-lg font-medium border transition', form.type==='income' ? 'bg-green-500/10 text-green-500 border-green-500' : 'border-slate-300 dark:border-slate-700 text-slate-500']">Thu nh·∫≠p</button>
                                </div>
                                <input v-model="form.date" type="date" required class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none">
                                <select v-model="form.category" class="bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none">
                                    <option v-for="c in availableCategories" :value="c">{{ c }}</option>
                                </select>
                                <input v-model="form.note" type="text" placeholder="Ghi ch√∫ (T√πy ch·ªçn)" class="col-span-1 md:col-span-2 bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg p-2.5 outline-none">
                                
                                <button type="submit" class="col-span-1 md:col-span-2 bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95 flex justify-center gap-2">
                                    <i data-lucide="check"></i> L∆∞u Giao D·ªãch
                                </button>
                            </form>
                        </div>

                        <div class="flex gap-3 justify-center">
                            <button @click="generateDemoData" class="px-4 py-2 bg-slate-200 dark:bg-slate-800 rounded-lg text-sm hover:bg-slate-300 dark:hover:bg-slate-700 transition">
                                + Th√™m 10 Giao d·ªãch Demo
                            </button>
                            <button @click="resetData" class="px-4 py-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg text-sm hover:bg-red-200 transition">
                                Reset D·ªØ li·ªáu
                            </button>
                        </div>

                        <div class="glass rounded-xl overflow-hidden">
                            <div class="p-4 border-b border-slate-200 dark:border-white/5 font-bold">Giao d·ªãch g·∫ßn ƒë√¢y</div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-slate-100 dark:bg-slate-800/50 text-slate-500">
                                        <tr>
                                            <th class="p-3">Ng√†y</th>
                                            <th class="p-3">Danh m·ª•c</th>
                                            <th class="p-3">Ghi ch√∫</th>
                                            <th class="p-3 text-right">S·ªë ti·ªÅn</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200 dark:divide-slate-700/50">
                                        <tr v-for="tx in recentTransactions" :key="tx.id" class="hover:bg-black/5 dark:hover:bg-white/5">
                                            <td class="p-3 text-slate-500">{{ tx.date }}</td>
                                            <td class="p-3 font-medium">{{ tx.category }}</td>
                                            <td class="p-3 text-slate-400">{{ tx.note }}</td>
                                            <td :class="['p-3 text-right font-bold', tx.type==='income'?'text-green-500':'text-red-500']">
                                                {{ tx.type==='income'?'+':'-' }}{{ formatMoney(tx.amount) }}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentPage === 'settings'" class="max-w-2xl mx-auto space-y-6">
                        <div class="glass p-6 rounded-xl">
                            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="settings" class="text-brand-500"></i> C√†i ƒê·∫∑t Chung</h2>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1">ƒê∆°n v·ªã ti·ªÅn t·ªá</label>
                                    <select v-model="settings.currency" @change="saveSettings" class="w-full p-2.5 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 outline-none">
                                        <option value="‚Ç´">Vi·ªát Nam ƒê·ªìng (‚Ç´)</option>
                                        <option value="$">USD ($)</option>
                                        <option value="‚Ç¨">Euro (‚Ç¨)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-500 mb-1">Ng√¢n s√°ch th√°ng</label>
                                    <input v-model.number="settings.monthlyBudget" @change="saveSettings" type="number" class="w-full p-2.5 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 outline-none">
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <nav class="md:hidden glass fixed bottom-0 w-full h-16 flex justify-around items-center border-t border-white/5 pb-safe z-40 bg-white/90 dark:bg-dark-900/90 backdrop-blur-md">
                    <button v-for="page in pages" :key="page.id" @click="currentPage = page.id" 
                        :class="['flex flex-col items-center gap-1 p-2 rounded-lg transition', currentPage === page.id ? 'text-brand-500' : 'text-slate-400']">
                        <i :data-lucide="page.icon" class="w-6 h-6"></i>
                        <span class="text-[10px] font-medium">{{ page.label }}</span>
                    </button>
                </nav>
            </main>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        // --- FIREBASE CONFIG (C·ª¶A B·∫†N) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmV3I9ZQ-N866cZ5mzMhVLNHcKjfL8cQ0",
            authDomain: "financial-tracking-app-bb3cb.firebaseapp.com",
            databaseURL: "https://financial-tracking-app-bb3cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "financial-tracking-app-bb3cb",
            storageBucket: "financial-tracking-app-bb3cb.firebasestorage.app",
            messagingSenderId: "242060161334",
            appId: "1:242060161334:web:e9a4e0c7f8758cd9770397",
            measurementId: "G-NV4B6CWRBS"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        createApp({
            setup() {
                // --- STATE ---
                const user = ref(null);
                const currentPage = ref('dashboard');
                const isDark = ref(localStorage.getItem('wp_theme') !== 'light'); // Default Dark
                const rawTransactions = ref([]);
                const settings = ref({ currency: '‚Ç´', monthlyBudget: 10000000 });
                
                // Filters State
                const filters = ref({
                    month: 'all',
                    type: 'all',
                    visualCategory: null, // From Donut/Bar click
                    dateRange: null // From Line Chart selection
                });

                const form = ref({ amount: '', type: 'expense', category: 'ƒÇn u·ªëng', date: new Date().toISOString().split('T')[0], note: '' });

                const pages = [
                    { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                    { id: 'add', label: 'Giao d·ªãch', icon: 'plus-circle' },
                    { id: 'settings', label: 'C√†i ƒë·∫∑t', icon: 'settings' }
                ];

                const categories = {
                    expense: ['ƒÇn u·ªëng', 'Di chuy·ªÉn', 'Nh√† c·ª≠a', 'Mua s·∫Øm', 'Gi·∫£i tr√≠', 'S·ª©c kh·ªèe', 'H√≥a ƒë∆°n'],
                    income: ['L∆∞∆°ng', 'Th∆∞·ªüng', 'ƒê·∫ßu t∆∞', 'B√°n h√†ng', 'Kh√°c']
                };

                // --- COMPUTED DATA (THE CORE ENGINE) ---
                const availableMonths = computed(() => [...new Set(rawTransactions.value.map(t => t.date.substring(0, 7)))].sort().reverse());
                const availableCategories = computed(() => categories[form.value.type]);

                // Filter Logic: Applies Global + Visual Filters
                const processedData = computed(() => {
                    return rawTransactions.value.filter(t => {
                        // 1. Global Dropdowns
                        if (filters.value.month !== 'all' && !t.date.startsWith(filters.value.month)) return false;
                        if (filters.value.type !== 'all' && t.type !== filters.value.type) return false;
                        
                        // 2. Visual Cross-filters
                        if (filters.value.visualCategory && t.category !== filters.value.visualCategory) return false;
                        if (filters.value.dateRange) {
                            if (t.date < filters.value.dateRange[0] || t.date > filters.value.dateRange[1]) return false;
                        }
                        return true;
                    }).sort((a, b) => new Date(a.date) - new Date(b.date));
                });

                // KPI Calculations
                const kpi = computed(() => {
                    const data = processedData.value;
                    const inc = data.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                    const exp = data.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                    const used = settings.value.monthlyBudget ? (exp / settings.value.monthlyBudget) * 100 : 0;
                    return { income: inc, expense: exp, savings: inc - exp, budgetUsed: used.toFixed(1) };
                });

                const recentTransactions = computed(() => [...processedData.value].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10));

                // --- ACTIONS ---
                const login = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                const logout = () => auth.signOut();
                
                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    localStorage.setItem('wp_theme', isDark.value ? 'dark' : 'light');
                    document.documentElement.className = isDark.value ? 'dark' : 'light';
                    renderCharts(); // Redraw charts for theme colors
                };

                const formatMoney = (n) => new Intl.NumberFormat('vi-VN').format(n) + settings.value.currency;
                const formatDateShort = (d) => new Date(d).toLocaleDateString('vi-VN', {day:'numeric', month:'numeric'});

                const resetVisualFilters = () => {
                    filters.value.visualCategory = null;
                    filters.value.dateRange = null;
                };

                const saveSettings = () => {
                    if(user.value) db.ref(`users/${user.value.uid}/settings`).set(settings.value);
                };

                const addTransaction = () => {
                    if (!user.value) return;
                    db.ref(`users/${user.value.uid}/transactions`).push({ ...form.value, id: Date.now() });
                    form.value.amount = ''; form.value.note = '';
                    alert('ƒê√£ l∆∞u!');
                };

                const resetData = () => {
                    if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) db.ref(`users/${user.value.uid}/transactions`).remove();
                };

                const generateDemoData = () => {
                    if (!user.value) return;
                    const demoTxs = [];
                    for(let i=0; i<10; i++) {
                        const isInc = Math.random() > 0.7;
                        const d = new Date(); d.setDate(d.getDate() - Math.floor(Math.random()*60));
                        demoTxs.push({
                            id: Date.now() + i,
                            date: d.toISOString().split('T')[0],
                            type: isInc ? 'income' : 'expense',
                            category: isInc ? categories.income[Math.floor(Math.random()*categories.income.length)] : categories.expense[Math.floor(Math.random()*categories.expense.length)],
                            amount: Math.floor(Math.random() * 1000000) + 50000,
                            note: 'Demo Transaction'
                        });
                    }
                    // Batch update requires building an object
                    demoTxs.forEach(tx => db.ref(`users/${user.value.uid}/transactions`).push(tx));
                };

                const downloadCSV = () => {
                    const header = "Date,Type,Category,Amount,Note\n";
                    const rows = processedData.value.map(t => `${t.date},${t.type},${t.category},${t.amount},${t.note || ''}`).join("\n");
                    const blob = new Blob([header + rows], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'wealthpulse_data.csv'; a.click();
                };

                const exportPDF = () => {
                    const el = document.getElementById('main-view');
                    html2canvas(el, { scale: 2, backgroundColor: isDark.value ? '#0f172a' : '#f3f4f6' }).then(canvas => {
                        const img = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                        const w = pdf.internal.pageSize.getWidth();
                        const h = (canvas.height * w) / canvas.width;
                        pdf.addImage(img, 'PNG', 0, 0, w, h);
                        pdf.save('dashboard-report.pdf');
                    });
                };

                // --- CHART ENGINE (PLOTLY) ---
                const renderCharts = () => {
                    if (currentPage.value !== 'dashboard' || !rawTransactions.value.length) return;
                    nextTick(() => {
                        const data = processedData.value;
                        const textColor = isDark.value ? '#94a3b8' : '#475569';
                        const gridColor = isDark.value ? '#334155' : '#e2e8f0';
                        const layoutBase = {
                            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                            font: { color: textColor },
                            margin: { t: 10, b: 30, l: 30, r: 10 },
                            xaxis: { showgrid: false, gridcolor: gridColor },
                            yaxis: { showgrid: true, gridcolor: gridColor },
                            showlegend: false
                        };

                        // 1. Line Trend (Income vs Expense)
                        // Group by date
                        const dates = [...new Set(data.map(t => t.date))].sort();
                        const incTrend = dates.map(d => data.filter(t => t.date === d && t.type === 'income').reduce((s,t) => s+t.amount, 0));
                        const expTrend = dates.map(d => data.filter(t => t.date === d && t.type === 'expense').reduce((s,t) => s+t.amount, 0));
                        
                        Plotly.newPlot('chart-trend', [
                            { x: dates, y: incTrend, type: 'scatter', mode: 'lines', name: 'Thu', line: {color: '#10B981', width: 3} },
                            { x: dates, y: expTrend, type: 'scatter', mode: 'lines', name: 'Chi', line: {color: '#EF4444', width: 3} }
                        ], { ...layoutBase, dragmode: 'select', showlegend: true }, {displayModeBar: false});

                        // Event: Selection for Date Range Filter
                        document.getElementById('chart-trend').on('plotly_selected', (eventData) => {
                            if (eventData) {
                                const range = eventData.range.x;
                                filters.value.dateRange = [range[0].substring(0,10), range[1].substring(0,10)];
                            } else {
                                filters.value.dateRange = null; // Double click to reset
                            }
                        });

                        // 2. Budget vs Actual (Cumulative)
                        // Simple linear budget accumulation for demo
                        let cumExp = 0;
                        const expCumLine = dates.map(d => {
                            cumExp += data.filter(t => t.date === d && t.type === 'expense').reduce((s,t) => s+t.amount, 0);
                            return cumExp;
                        });
                        const budgetLine = dates.map((_, i) => (settings.value.monthlyBudget / 30) * (i+1)); // Approx

                        Plotly.newPlot('chart-budget', [
                            { x: dates, y: expCumLine, type: 'scatter', fill: 'tozeroy', name: 'Th·ª±c t·∫ø', line: {color: '#A855F7'} },
                            { x: dates, y: budgetLine, type: 'scatter', mode: 'lines', name: 'Ng√¢n s√°ch', line: {color: '#64748B', dash: 'dot'} }
                        ], layoutBase, {displayModeBar: false});

                        // 3. Donut Expense by Category
                        const expData = data.filter(t => t.type === 'expense');
                        const catMap = {};
                        expData.forEach(t => catMap[t.category] = (catMap[t.category] || 0) + t.amount);
                        
                        Plotly.newPlot('chart-category', [{
                            labels: Object.keys(catMap), values: Object.values(catMap),
                            type: 'pie', hole: 0.5,
                            marker: { colors: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6'] }
                        }], layoutBase, {displayModeBar: false});

                        // Event: Click to filter category
                        document.getElementById('chart-category').on('plotly_click', (data) => {
                            filters.value.visualCategory = data.points[0].label;
                        });

                        // 4. Bar Top Categories vs Budget (Budget is fake per cat for demo)
                        const sortedCats = Object.entries(catMap).sort((a,b) => b[1] - a[1]).slice(0, 5);
                        Plotly.newPlot('chart-top-cat', [
                            { x: sortedCats.map(c=>c[0]), y: sortedCats.map(c=>c[1]), type: 'bar', marker: {color: '#F97316'} }
                        ], layoutBase, {displayModeBar: false});

                         document.getElementById('chart-top-cat').on('plotly_click', (data) => {
                            filters.value.visualCategory = data.points[0].x;
                        });

                        // 5. Daily Net Savings (Area)
                        const savTrend = dates.map((d, i) => incTrend[i] - expTrend[i]);
                        Plotly.newPlot('chart-area-savings', [
                            { x: dates, y: savTrend, type: 'scatter', fill: 'tozeroy', line: {color: '#3B82F6'} }
                        ], layoutBase, {displayModeBar: false});

                        // 6. Weekend vs Weekday
                        let weekAmt = 0, endAmt = 0;
                        expData.forEach(t => {
                            const day = new Date(t.date).getDay();
                            (day === 0 || day === 6) ? endAmt += t.amount : weekAmt += t.amount;
                        });
                        Plotly.newPlot('chart-weekend', [{
                            labels: ['Trong tu·∫ßn', 'Cu·ªëi tu·∫ßn'], values: [weekAmt, endAmt], type: 'pie', hole: 0.5,
                            marker: { colors: ['#3B82F6', '#14B8A6'] }
                        }], layoutBase, {displayModeBar: false});
                    });
                };

                // --- LIFECYCLE ---
                onMounted(() => {
                    // Initialize Theme
                    if(isDark.value) document.documentElement.classList.add('dark');
                    
                    auth.onAuthStateChanged(u => {
                        user.value = u;
                        if (u) {
                            // Listen to Transactions
                            db.ref(`users/${u.uid}/transactions`).on('value', snap => {
                                const val = snap.val();
                                rawTransactions.value = val ? Object.values(val) : [];
                            });
                            // Listen to Settings
                            db.ref(`users/${u.uid}/settings`).on('value', snap => {
                                if(snap.val()) settings.value = snap.val();
                            });
                        } else {
                            rawTransactions.value = [];
                        }
                    });
                });

                // Watch for changes to redraw charts
                watch([processedData, currentPage, isDark], () => {
                    renderCharts();
                    setTimeout(() => lucide.createIcons(), 100);
                });

                return {
                    user, currentPage, isDark, filters, form, settings, kpi,
                    availableMonths, availableCategories, recentTransactions,
                    login, logout, toggleTheme, saveSettings,
                    addTransaction, resetData, generateDemoData,
                    downloadCSV, exportPDF, resetVisualFilters,
                    formatMoney, formatDateShort
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
