<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #0078d4;
            --primary-bg: rgba(0, 120, 212, 0.1);
            --bg-body: #f3f2f1;
            --bg-card: #ffffff;
            --text-main: #201f1e;
            --text-muted: #605e5c;
            --border: #e1dfdd;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 8px;
            --sidebar-width: 250px;
            --header-height: 60px;
        }

        .dark-mode {
            --primary: #4cc9f0;
            --primary-bg: rgba(76, 201, 240, 0.15);
            --bg-body: #111111;
            --bg-card: #1f1f1f;
            --text-main: #f3f2f1;
            --text-muted: #a19f9d;
            --border: #333333;
            --shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }

        /* --- LAYOUT --- */
        #sidebar { width: var(--sidebar-width); background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 50; transition: 0.3s; }
        #main { flex: 1; display: flex; flex-direction: column; height: 100vh; position: relative; }
        
        /* Sidebar Elements */
        .brand { height: var(--header-height); display: flex; align-items: center; padding: 0 20px; font-weight: 700; font-size: 18px; color: var(--primary); border-bottom: 1px solid var(--border); gap: 10px; }
        .user-panel { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .nav-item { padding: 12px 20px; cursor: pointer; color: var(--text-muted); font-weight: 500; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: var(--primary-bg); color: var(--primary); border-right: 3px solid var(--primary); }

        /* Top Filter Bar */
        .filter-bar { 
            background: var(--bg-card); padding: 10px 20px; 
            border-bottom: 1px solid var(--border); display: flex; flex-wrap: wrap; gap: 10px; align-items: center; 
            z-index: 40; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        select, .btn { height: 36px; padding: 0 12px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main); font-family: 'Segoe UI'; cursor: pointer; }
        .btn { background: var(--primary); color: white; border: none; font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: #d13438; color: white; }
        
        /* Filter Chips */
        .chip-container { display: flex; gap: 8px; flex-wrap: wrap; margin-left: auto; }
        .chip { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px; }
        .chip i { cursor: pointer; }

        /* Content Pages */
        .page { display: none; padding: 20px; overflow-y: auto; flex: 1; height: 100%; }
        .page.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:translateY(0)} }

        /* Dashboard Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .kpi-val { font-size: 24px; font-weight: 700; margin: 5px 0; }
        .kpi-label { font-size: 13px; color: var(--text-muted); text-transform: uppercase; }

        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .chart-full { grid-column: span 2; }
        .chart-container { height: 350px; width: 100%; }

        /* Tables & Forms */
        .table-scroll { max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        th { position: sticky; top: 0; background: var(--bg-body); padding: 12px; text-align: left; font-size: 13px; color: var(--text-muted); z-index: 2; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:hover td { background: var(--primary-bg); }

        .action-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
        .action-btn:hover { color: var(--primary); }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal.open { display: flex; }
        .modal-content { background: var(--bg-card); padding: 25px; border-radius: 12px; width: 400px; box-shadow: var(--shadow); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 5px; color: var(--text-muted); font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 10px; }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; background: var(--bg-body); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        
        /* Mobile */
        #bottom-nav { display: none; }
        @media (max-width: 768px) {
            #sidebar { display: none; }
            #bottom-nav { display: flex; position: fixed; bottom: 0; width: 100%; background: var(--bg-card); padding: 10px; justify-content: space-around; border-top: 1px solid var(--border); z-index: 100; }
            .charts-grid { grid-template-columns: 1fr; }
            .chart-full { grid-column: span 1; }
            .filter-bar { flex-direction: column; align-items: stretch; }
            .chip-container { margin-left: 0; }
            #main { padding-bottom: 60px; }
        }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="card" style="text-align: center; width: 320px;">
            <h2 style="color: var(--primary);"><i class="fas fa-chart-pie"></i> FinDash</h2>
            <p style="margin-bottom: 20px; color: var(--text-muted);">Please sign in to continue</p>
            <button id="btn-google" class="btn" style="width: 100%; justify-content: center;">
                <i class="fab fa-google"></i> Sign in with Google
            </button>
        </div>
    </div>

    <aside id="sidebar">
        <div class="brand"><i class="fas fa-chart-line"></i> Analytics Pro</div>
        <div class="user-panel">
            <img id="u-avatar" class="avatar">
            <div style="overflow: hidden;">
                <div id="u-name" style="font-weight: 600; font-size: 14px; white-space: nowrap;">User</div>
                <div style="font-size: 11px; color: var(--text-muted);">Premium</div>
            </div>
        </div>
        <div style="padding: 10px;">
            <div class="nav-item active" onclick="app.nav('dashboard')"><i class="fas fa-home"></i> Dashboard</div>
            <div class="nav-item" onclick="app.nav('add')"><i class="fas fa-list"></i> Transactions</div>
            <div class="nav-item" onclick="app.nav('settings')"><i class="fas fa-cog"></i> Settings</div>
        </div>
        <div style="margin-top: auto; padding: 10px;">
            <div class="nav-item" onclick="app.toggleTheme()"><i class="fas fa-adjust"></i> Theme</div>
            <div class="nav-item" onclick="app.logout()" style="color: #d13438;"><i class="fas fa-sign-out-alt"></i> Logout</div>
        </div>
    </aside>

    <main id="main">
        <div class="filter-bar">
            <select id="f-month" onchange="app.filterData()"></select>
            <select id="f-type" onchange="app.filterData()">
                <option value="all">All Types</option>
                <option value="Income">Income</option>
                <option value="Expense">Expense</option>
            </select>
            <select id="f-cat" onchange="app.filterData()"></select>
            
            <div id="active-filters" class="chip-container"></div>
            
            <button class="btn btn-outline" onclick="app.resetFilters()" title="Reset All"><i class="fas fa-sync"></i></button>
            <button class="btn btn-outline" onclick="app.exportPDF()"><i class="fas fa-file-pdf"></i></button>
        </div>

        <div id="page-dashboard" class="page active">
            <div class="kpi-grid">
                <div class="card">
                    <div class="kpi-label">Total Income</div>
                    <div class="kpi-val" style="color: #107c10;" id="kpi-inc">0</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Total Expense</div>
                    <div class="kpi-val" style="color: #d13438;" id="kpi-exp">0</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Net Savings</div>
                    <div class="kpi-val" style="color: var(--primary);" id="kpi-save">0</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Budget Used</div>
                    <div class="kpi-val" id="kpi-budget">0%</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="card chart-full">
                    <div style="font-weight: 600; margin-bottom: 10px;">Income vs Expense Trend (Drag to Filter)</div>
                    <div id="chart-trend" class="chart-container"></div>
                </div>
                
                <div class="card">
                    <div style="font-weight: 600; margin-bottom: 10px;">Expense by Category (Click to Filter)</div>
                    <div id="chart-donut" class="chart-container"></div>
                </div>
                <div class="card">
                    <div style="font-weight: 600; margin-bottom: 10px;">Budget vs Actual (Cumulative)</div>
                    <div id="chart-budget-line" class="chart-container"></div>
                </div>

                <div class="card">
                    <div style="font-weight: 600; margin-bottom: 10px;">Top Spending Categories</div>
                    <div id="chart-bar" class="chart-container"></div>
                </div>
                <div class="card">
                    <div style="font-weight: 600; margin-bottom: 10px;">Daily Net Savings</div>
                    <div id="chart-area" class="chart-container"></div>
                </div>
                
                <div class="card">
                    <div style="font-weight: 600; margin-bottom: 10px;">Weekday vs Weekend</div>
                    <div id="chart-week" class="chart-container"></div>
                </div>
            </div>
        </div>

        <div id="page-add" class="page">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                
                <div class="card" style="flex: 1; min-width: 300px; height: fit-content;">
                    <h3 style="margin-top:0">Add New Transaction</h3>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="tx-date">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select id="tx-type">
                            <option value="Expense">Expense</option>
                            <option value="Income">Income</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="tx-cat" list="cat-list" placeholder="Food, Salary...">
                        <datalist id="cat-list"><option value="Food"><option value="Rent"><option value="Transport"></datalist>
                    </div>
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="number" id="tx-amt" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Note</label>
                        <input type="text" id="tx-note">
                    </div>
                    <button class="btn" onclick="app.addTx()" style="width:100%; justify-content:center;">Add Transaction</button>
                    
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-outline" style="flex:1" onclick="app.genDemo()">+10 Demo</button>
                        <button class="btn btn-danger" onclick="app.clearData()"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div class="card" style="flex: 2; min-width: 300px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin:0">Recent Activity</h3>
                        <button class="btn btn-outline" style="height: 30px; font-size: 12px;" onclick="app.exportCSV()">Export CSV</button>
                    </div>
                    
                    <div class="table-scroll">
                        <table id="tx-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Type</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tx-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="page-settings" class="page">
            <div class="card" style="max-width: 500px;">
                <h3>Preferences</h3>
                <div class="form-group">
                    <label>Currency Symbol</label>
                    <select id="s-curr" onchange="app.saveSettings()">
                        <option value="$">USD ($)</option>
                        <option value="₫">VND (₫)</option>
                        <option value="€">EUR (€)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Monthly Budget</label>
                    <input type="number" id="s-budget" onchange="app.saveSettings()">
                </div>
            </div>
        </div>
    </main>

    <nav id="bottom-nav">
        <div class="nav-item active" onclick="app.nav('dashboard')"><i class="fas fa-home"></i></div>
        <div class="nav-item" onclick="app.nav('add')"><i class="fas fa-list"></i></div>
        <div class="nav-item" onclick="app.nav('settings')"><i class="fas fa-cog"></i></div>
    </nav>

    <div id="modal-edit" class="modal">
        <div class="modal-content">
            <h3>Edit Transaction</h3>
            <input type="hidden" id="e-id">
            <div class="form-group"><label>Date</label><input type="date" id="e-date"></div>
            <div class="form-group"><label>Type</label><select id="e-type"><option value="Expense">Expense</option><option value="Income">Income</option></select></div>
            <div class="form-group"><label>Category</label><input type="text" id="e-cat"></div>
            <div class="form-group"><label>Amount</label><input type="number" id="e-amt"></div>
            <div class="form-group"><label>Note</label><input type="text" id="e-note"></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex:1" onclick="app.updateTx()">Update</button>
                <button class="btn btn-outline" style="flex:1" onclick="document.getElementById('modal-edit').classList.remove('open')">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // CONFIG
        const appConfig = {
            apiKey: "AIzaSyDmV3I9ZQ-N866cZ5mzMhVLNHcKjfL8cQ0",
            authDomain: "financial-tracking-app-bb3cb.firebaseapp.com",
            databaseURL: "https://financial-tracking-app-bb3cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "financial-tracking-app-bb3cb",
            appId: "1:242060161334:web:e9a4e0c7f8758cd9770397"
        };

        const fApp = initializeApp(appConfig);
        const db = getDatabase(fApp);
        const auth = getAuth(fApp);

        // GLOBAL STATE
        window.app = {
            user: null,
            rawData: [], // Raw from firebase
            data: [], // Array converted
            settings: { curr: '₫', budget: 10000000 },
            filters: { month: 'all', type: 'all', cat: 'all' },
            visualFilters: { cat: null, dateRange: null }, // Visual Cross-Filtering State

            // --- AUTH ---
            init: () => {
                document.getElementById('btn-google').addEventListener('click', () => {
                    signInWithPopup(auth, new GoogleAuthProvider());
                });

                onAuthStateChanged(auth, u => {
                    app.user = u;
                    if(u) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('u-avatar').src = u.photoURL;
                        document.getElementById('u-name').innerText = u.displayName;
                        
                        // Listen to Data
                        const dbRef = ref(db, `users/${u.uid}/transactions`);
                        onValue(dbRef, (snap) => {
                            const val = snap.val();
                            app.rawData = val || {};
                            // Convert to array and Sort by Date Descending
                            app.data = Object.entries(app.rawData).map(([k, v]) => ({id: k, ...v}))
                                .sort((a,b) => new Date(b.date) - new Date(a.date));
                            
                            app.updateUI(); // Main Render
                        });

                        // Load Settings
                        const s = localStorage.getItem('s_' + u.uid);
                        if(s) app.settings = JSON.parse(s);
                        document.getElementById('s-curr').value = app.settings.curr;
                        document.getElementById('s-budget').value = app.settings.budget;
                        document.getElementById('tx-date').valueAsDate = new Date();
                    } else {
                        document.getElementById('login-screen').style.display = 'flex';
                    }
                });
            },

            logout: () => signOut(auth),

            // --- NAVIGATION ---
            nav: (page) => {
                document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
                document.getElementById('page-' + page).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                // Simple logic for active nav highlight
                if(page === 'dashboard') setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            },
            
            toggleTheme: () => {
                document.body.classList.toggle('dark-mode');
                app.renderDashboard(); // Re-render charts
            },

            // --- DATA OPERATIONS ---
            addTx: () => {
                const date = document.getElementById('tx-date').value;
                const type = document.getElementById('tx-type').value;
                const cat = document.getElementById('tx-cat').value;
                const amt = parseFloat(document.getElementById('tx-amt').value);
                const note = document.getElementById('tx-note').value;
                
                if(!date || !cat || isNaN(amt)) return alert("Missing fields");
                
                push(ref(db, `users/${app.user.uid}/transactions`), { date, type, category: cat, amount: amt, note });
                // Note: No need to manually update UI, onValue listener does it.
                document.getElementById('tx-amt').value = '';
                document.getElementById('tx-note').value = '';
                alert("Added!");
            },

            // Edit Logic
            openEdit: (id) => {
                const tx = app.rawData[id];
                document.getElementById('e-id').value = id;
                document.getElementById('e-date').value = tx.date;
                document.getElementById('e-type').value = tx.type;
                document.getElementById('e-cat').value = tx.category;
                document.getElementById('e-amt').value = tx.amount;
                document.getElementById('e-note').value = tx.note || '';
                document.getElementById('modal-edit').classList.add('open');
            },

            updateTx: () => {
                const id = document.getElementById('e-id').value;
                const date = document.getElementById('e-date').value;
                const type = document.getElementById('e-type').value;
                const cat = document.getElementById('e-cat').value;
                const amt = parseFloat(document.getElementById('e-amt').value);
                const note = document.getElementById('e-note').value;

                update(ref(db, `users/${app.user.uid}/transactions/${id}`), { date, type, category: cat, amount: amt, note });
                document.getElementById('modal-edit').classList.remove('open');
            },

            deleteTx: (id) => {
                if(confirm("Delete transaction?")) remove(ref(db, `users/${app.user.uid}/transactions/${id}`));
            },

            genDemo: () => {
                const cats = ['Food', 'Transport', 'Rent', 'Salary', 'Shopping'];
                for(let i=0; i<10; i++) {
                    const type = Math.random() > 0.4 ? 'Expense' : 'Income';
                    push(ref(db, `users/${app.user.uid}/transactions`), {
                        date: new Date().toISOString().split('T')[0],
                        type,
                        category: cats[Math.floor(Math.random()*cats.length)],
                        amount: Math.floor(Math.random()*2000)+100,
                        note: 'Demo'
                    });
                }
            },
            
            clearData: () => {
               if(confirm("Clear ALL?")) set(ref(db, `users/${app.user.uid}/transactions`), null);
            },

            saveSettings: () => {
                app.settings.curr = document.getElementById('s-curr').value;
                app.settings.budget = document.getElementById('s-budget').value;
                localStorage.setItem('s_' + app.user.uid, JSON.stringify(app.settings));
                app.updateUI();
            },

            // --- FILTERING LOGIC (CORE) ---
            getFiltered: () => {
                return app.data.filter(d => {
                    // Dropdown Filters
                    const m = app.filters.month === 'all' || d.date.startsWith(app.filters.month);
                    const t = app.filters.type === 'all' || d.type === app.filters.type;
                    const c = app.filters.cat === 'all' || d.category === app.filters.cat;
                    
                    // Visual Filters
                    const vc = !app.visualFilters.cat || d.category === app.visualFilters.cat;
                    const vd = !app.visualFilters.dateRange || (d.date >= app.visualFilters.dateRange[0] && d.date <= app.visualFilters.dateRange[1]);

                    return m && t && c && vc && vd;
                });
            },

            filterData: () => {
                app.filters.month = document.getElementById('f-month').value;
                app.filters.type = document.getElementById('f-type').value;
                app.filters.cat = document.getElementById('f-cat').value;
                app.updateUI();
            },
            
            setVisualFilter: (key, val) => {
                app.visualFilters[key] = val;
                app.updateUI();
            },

            resetFilters: () => {
                app.filters = { month: 'all', type: 'all', cat: 'all' };
                app.visualFilters = { cat: null, dateRange: null };
                document.getElementById('f-month').value = 'all';
                document.getElementById('f-type').value = 'all';
                document.getElementById('f-cat').value = 'all';
                app.updateUI();
            },

            // --- RENDERING ---
            updateUI: () => {
                // Populate Dropdowns dynamically
                const months = [...new Set(app.data.map(d=>d.date.substring(0,7)))].sort().reverse();
                const cats = [...new Set(app.data.map(d=>d.category))].sort();
                
                const pop = (id, arr, def) => {
                    const el = document.getElementById(id);
                    if(el.options.length <= 1) arr.forEach(v => el.add(new Option(v,v)));
                };
                pop('f-month', months); pop('f-cat', cats);

                // Filter Chips Display
                const chips = document.getElementById('active-filters');
                chips.innerHTML = '';
                if(app.visualFilters.cat) chips.innerHTML += `<span class="chip">Cat: ${app.visualFilters.cat} <i class="fas fa-times" onclick="app.setVisualFilter('cat', null)"></i></span>`;
                if(app.visualFilters.dateRange) chips.innerHTML += `<span class="chip">Date Range <i class="fas fa-times" onclick="app.setVisualFilter('dateRange', null)"></i></span>`;

                app.renderTable();
                app.renderDashboard();
            },

            renderTable: () => {
                const tbody = document.getElementById('tx-body');
                tbody.innerHTML = '';
                // Render filtered data in table
                app.getFiltered().slice(0, 50).forEach(tx => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${tx.date}</td>
                        <td>${tx.category}</td>
                        <td style="color:${tx.type==='Income'?'#107c10':'#d13438'}">${tx.type}</td>
                        <td>${app.settings.curr}${parseFloat(tx.amount).toLocaleString()}</td>
                        <td>
                            <button class="action-btn" onclick="app.openEdit('${tx.id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" onclick="app.deleteTx('${tx.id}')" style="color:#d13438"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            },

            renderDashboard: () => {
                const data = app.getFiltered();
                const isDark = document.body.classList.contains('dark-mode');
                const tc = isDark ? '#fff' : '#201f1e';
                const grid = isDark ? '#333' : '#e1dfdd';
                const cur = app.settings.curr;

                // KPI Calc
                const inc = data.filter(d=>d.type==='Income').reduce((s,x)=>s+x.amount,0);
                const exp = data.filter(d=>d.type==='Expense').reduce((s,x)=>s+x.amount,0);
                document.getElementById('kpi-inc').innerText = cur + inc.toLocaleString();
                document.getElementById('kpi-exp').innerText = cur + exp.toLocaleString();
                document.getElementById('kpi-save').innerText = cur + (inc-exp).toLocaleString();
                document.getElementById('kpi-budget').innerText = ((exp/app.settings.budget)*100).toFixed(1) + '%';

                // Chart Layout Shared
                const layout = {
                    paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI', color: tc },
                    margin: { t: 10, l: 30, r: 10, b: 30 },
                    xaxis: { gridcolor: grid }, yaxis: { gridcolor: grid },
                    showlegend: true, legend: { orientation: 'h', y: -0.1 }
                };

                // 1. Line Trend (Income vs Expense)
                const dates = [...new Set(data.map(d=>d.date))].sort();
                const incS = dates.map(d => data.filter(x=>x.date===d && x.type==='Income').reduce((s,v)=>s+v.amount,0));
                const expS = dates.map(d => data.filter(x=>x.date===d && x.type==='Expense').reduce((s,v)=>s+v.amount,0));
                
                Plotly.react('chart-trend', [
                    { x: dates, y: incS, name: 'Income', type: 'scatter', line: {color: '#107c10', width: 3} },
                    { x: dates, y: expS, name: 'Expense', type: 'scatter', line: {color: '#d13438', width: 3} }
                ], {...layout, dragmode: 'select'}, {displayModeBar: false, responsive: true})
                .then(gd => gd.on('plotly_selected', d => { if(d) app.setVisualFilter('dateRange', d.range.x); }));

                // 2. Donut Expense Cat
                const exps = data.filter(d=>d.type==='Expense');
                const catMap = {}; exps.forEach(d=>catMap[d.category]=(catMap[d.category]||0)+d.amount);
                Plotly.react('chart-donut', [{
                    labels: Object.keys(catMap), values: Object.values(catMap), type: 'pie', hole: 0.5,
                    marker: { colors: ['#0078d4','#00bcf2','#00cc6a','#ffb900','#f7630c','#e81123'] }
                }], layout, {displayModeBar: false, responsive: true})
                .then(gd => gd.on('plotly_click', d => app.setVisualFilter('cat', d.points[0].label)));

                // 3. Budget Line (Cumulative)
                let cum = 0;
                const cumVal = dates.map(d => { cum += data.filter(x=>x.date===d && x.type==='Expense').reduce((s,v)=>s+v.amount,0); return cum; });
                const budgetLine = dates.map((_, i) => (app.settings.budget/30)*(i+1)); // Linear approx
                
                Plotly.react('chart-budget-line', [
                    { x: dates, y: cumVal, name: 'Actual', type: 'scatter', fill: 'tozeroy', line: {color: '#0078d4'} },
                    { x: dates, y: budgetLine, name: 'Budget', type: 'scatter', mode: 'lines', line: {dash: 'dot', color: 'gray'} }
                ], layout, {displayModeBar: false, responsive: true});

                // 4. Bar Top Categories
                const sorted = Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
                Plotly.react('chart-bar', [{
                    x: sorted.map(x=>x[1]), y: sorted.map(x=>x[0]), type: 'bar', orientation: 'h', marker: {color: '#0078d4'}
                }], layout, {displayModeBar: false, responsive: true})
                .then(gd => gd.on('plotly_click', d => app.setVisualFilter('cat', d.points[0].label)));

                // 5. Area Daily Net Savings
                const net = dates.map(d => {
                    const i = data.filter(x=>x.date===d && x.type==='Income').reduce((s,v)=>s+v.amount,0);
                    const e = data.filter(x=>x.date===d && x.type==='Expense').reduce((s,v)=>s+v.amount,0);
                    return i-e;
                });
                Plotly.react('chart-area', [{
                    x: dates, y: net, type: 'scatter', fill: 'tozeroy', line: {color: '#107c10'}
                }], layout, {displayModeBar: false, responsive: true});

                // 6. Weekday vs Weekend
                let wDay = 0, wEnd = 0;
                exps.forEach(d => {
                    const day = new Date(d.date).getDay();
                    if(day===0 || day===6) wEnd += d.amount; else wDay += d.amount;
                });
                Plotly.react('chart-week', [{
                    labels: ['Weekday', 'Weekend'], values: [wDay, wEnd], type: 'pie', hole: 0.6,
                    marker: { colors: ['#0078d4', '#ffb900'] }
                }], layout, {displayModeBar: false, responsive: true});
            },

            exportCSV: () => {
                let csv = "Date,Type,Category,Amount,Note\n";
                app.getFiltered().forEach(d => csv += `${d.date},${d.type},${d.category},${d.amount},${d.note}\n`);
                const url = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
                const a = document.createElement('a'); a.href = url; a.download = 'data.csv'; a.click();
            },

            exportPDF: () => {
                const el = document.getElementById('page-dashboard');
                html2canvas(el, { scale: 2, backgroundColor: document.body.classList.contains('dark-mode') ? '#111' : '#f3f2f1' }).then(canvas => {
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const w = pdf.internal.pageSize.getWidth();
                    const h = (canvas.height * w) / canvas.width;
                    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, w, h);
                    pdf.save('dashboard.pdf');
                });
            }
        };

        app.init();
    </script>
</body>
</html>
