<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Analytics Dashboard Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* --- 1. RESET & TYPOGRAPHY --- */
        :root {
            --primary: #0078d4; /* Microsoft Blue */
            --primary-hover: #106ebe;
            --secondary: #2b88d8;
            --success: #107c10;
            --danger: #d13438;
            --warning: #ffb900;
            
            --bg-body: #f0f2f5;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.95);
            
            --text-main: #201f1e;
            --text-muted: #605e5c;
            
            --border: #e1dfdd;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.08), 0 0 1px rgba(0,0,0,0.1);
            --radius: 8px;
            
            --sidebar-width: 260px;
            --header-height: 64px;
        }

        .dark-mode {
            --primary: #4cc9f0;
            --primary-hover: #3a9dc2;
            --bg-body: #121212;
            --bg-card: #1e1e1e;
            --bg-glass: rgba(30, 30, 30, 0.95);
            --text-main: #f3f2f1;
            --text-muted: #a19f9d;
            --border: #323130;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: 'Segoe UI', 'Segoe UI Web (West European)', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            transition: background 0.3s, color 0.3s;
        }

        /* --- 2. COMPONENTS --- */
        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 8px 16px; border-radius: 4px; border: none; font-weight: 600;
            font-size: 14px; cursor: pointer; transition: all 0.2s ease;
            font-family: 'Segoe UI', sans-serif;
        }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,120,212,0.3); }
        .btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
        
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background-color: var(--bg-body); border-color: var(--primary); color: var(--primary); }
        
        .btn-danger { background-color: rgba(209, 52, 56, 0.1); color: var(--danger); }
        .btn-danger:hover { background-color: var(--danger); color: white; }

        /* Inputs */
        input, select {
            width: 100%; padding: 10px 12px; border-radius: 4px;
            border: 1px solid var(--border); background: var(--bg-card); color: var(--text-main);
            font-size: 14px; outline: none; transition: border 0.2s, box-shadow 0.2s;
            font-family: 'Segoe UI', sans-serif;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0,120,212,0.2); }

        /* Cards */
        .card {
            background-color: var(--bg-card); border-radius: var(--radius);
            box-shadow: var(--shadow-md); padding: 20px;
            border: 1px solid transparent;
            display: flex; flex-direction: column;
            position: relative;
        }
        .dark-mode .card { border: 1px solid var(--border); }

        /* --- 3. LAYOUT --- */
        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width); background-color: var(--bg-card);
            border-right: 1px solid var(--border); display: flex; flex-direction: column;
            z-index: 100; transition: transform 0.3s;
        }
        
        .brand {
            height: var(--header-height); display: flex; align-items: center; padding: 0 24px;
            font-size: 20px; font-weight: 700; color: var(--primary); gap: 10px;
            border-bottom: 1px solid var(--border);
        }

        .user-info {
            padding: 20px; display: flex; align-items: center; gap: 12px;
            border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.02);
        }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .user-details h4 { font-size: 14px; font-weight: 600; margin-bottom: 2px; }
        .user-details p { font-size: 12px; color: var(--text-muted); }

        .nav-menu { flex: 1; padding: 16px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
        .nav-item {
            padding: 12px 16px; border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; gap: 12px;
            color: var(--text-muted); font-weight: 500; font-size: 15px;
            transition: all 0.2s;
        }
        .nav-item:hover { background-color: var(--bg-body); color: var(--text-main); }
        .nav-item.active { background-color: rgba(0,120,212,0.1); color: var(--primary); font-weight: 600; }
        .nav-item.active::before {
            content: ''; position: absolute; left: 0; width: 4px; height: 24px;
            background: var(--primary); border-radius: 0 4px 4px 0;
        }

        /* Main Content */
        #main-content {
            flex: 1; display: flex; flex-direction: column; height: 100vh;
            position: relative; overflow: hidden;
        }

        /* Top Bar */
        .top-bar {
            height: var(--header-height); background: var(--bg-glass);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 24px; gap: 16px;
            z-index: 90; position: sticky; top: 0;
        }
        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-select { min-width: 140px; height: 36px; padding: 0 10px; }

        /* Page Container */
        .page-scroll { flex: 1; overflow-y: auto; padding: 24px; scroll-behavior: smooth; }
        .page { display: none; max-width: 1400px; margin: 0 auto; animation: fadeUp 0.4s ease-out; }
        .page.active { display: block; }

        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Dashboard Grid System */
        .kpi-row {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px; margin-bottom: 24px;
        }
        .kpi-card-content { display: flex; flex-direction: column; }
        .kpi-label { font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600; }
        .kpi-number { font-size: 28px; font-weight: 700; color: var(--text-main); margin: 8px 0 4px 0; }
        .kpi-trend { font-size: 13px; display: flex; align-items: center; gap: 4px; }
        .trend-up { color: var(--success); } .trend-down { color: var(--danger); }

        .chart-row {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 24px;
        }
        .chart-row.full { grid-template-columns: 1fr; }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .chart-title { font-size: 16px; font-weight: 600; color: var(--text-main); }

        /* Data Table */
        .table-wrapper { overflow-x: auto; border-radius: var(--radius); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); }
        th { background: var(--bg-body); padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 600; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: rgba(0,0,0,0.01); }

        /* --- 4. SCREENS (Login / Loading) --- */
        .overlay-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-body);
            display: flex; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }
        
        .login-box {
            width: 400px; padding: 40px; background: var(--bg-card);
            border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center; border: 1px solid var(--border);
        }
        .login-icon { font-size: 48px; color: var(--primary); margin-bottom: 20px; }
        .login-btn {
            width: 100%; margin-top: 24px; padding: 12px;
            background: white; border: 1px solid #ccc; border-radius: 6px;
            font-weight: 600; color: #555; display: flex; align-items: center; justify-content: center; gap: 12px;
            transition: all 0.2s;
        }
        .login-btn:hover { background: #f8f9fa; border-color: #bbb; }
        
        /* Spinner */
        .loader { width: 48px; height: 48px; border: 4px solid var(--border); border-bottom-color: var(--primary); border-radius: 50%; animation: rotate 1s linear infinite; }
        @keyframes rotate { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- 5. RESPONSIVE --- */
        #bottom-nav { display: none; }
        
        @media (max-width: 900px) {
            .chart-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); position: fixed; height: 100%; box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
            #sidebar.open { transform: translateX(0); }
            #main-content { margin-left: 0; padding-bottom: 70px; }
            
            .top-bar { flex-direction: column; height: auto; padding: 16px; align-items: stretch; }
            .filter-group { flex-wrap: wrap; }
            .filter-select { flex: 1; }
            
            #bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; right: 0;
                height: 60px; background: var(--bg-card); border-top: 1px solid var(--border);
                justify-content: space-around; align-items: center; z-index: 999;
                padding-bottom: env(safe-area-inset-bottom);
            }
            .b-nav-item { font-size: 20px; color: var(--text-muted); padding: 10px; border-radius: 50%; }
            .b-nav-item.active { color: var(--primary); background: rgba(0,120,212,0.1); }
        }
    </style>
</head>
<body>

    <div id="loading-screen" class="overlay-screen">
        <div style="text-align: center;">
            <div class="loader"></div>
            <p style="margin-top: 16px; font-weight: 600; color: var(--text-muted);">Initializing Dashboard...</p>
        </div>
    </div>

    <div id="login-screen" class="overlay-screen hidden">
        <div class="login-box">
            <div class="login-icon"><i class="fas fa-chart-pie"></i></div>
            <h2 style="margin-bottom: 8px;">Welcome Back</h2>
            <p style="color: var(--text-muted); margin-bottom: 24px;">Sign in to access your financial analytics.</p>
            <button id="btn-login-google" class="login-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="G">
                Continue with Google
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden" style="display: flex; width: 100%;">
        
        <aside id="sidebar">
            <div class="brand">
                <i class="fas fa-chart-line"></i> <span>FinSight Pro</span>
            </div>
            
            <div class="user-info">
                <img id="user-avatar" class="avatar" src="" alt="">
                <div class="user-details">
                    <h4 id="user-name">User</h4>
                    <p>Free Plan</p>
                </div>
            </div>

            <div class="nav-menu">
                <div class="nav-item active" onclick="app.navigate('dashboard')">
                    <i class="fas fa-home" style="width: 20px;"></i> Dashboard
                </div>
                <div class="nav-item" onclick="app.navigate('add')">
                    <i class="fas fa-plus-circle" style="width: 20px;"></i> Transactions
                </div>
                <div class="nav-item" onclick="app.navigate('settings')">
                    <i class="fas fa-cog" style="width: 20px;"></i> Settings
                </div>
            </div>

            <div style="padding: 16px; border-top: 1px solid var(--border);">
                <div class="nav-item" onclick="app.toggleTheme()">
                    <i class="fas fa-moon" style="width: 20px;"></i> Dark Mode
                </div>
                <div class="nav-item" onclick="app.logout()" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt" style="width: 20px;"></i> Sign Out
                </div>
            </div>
        </aside>

        <main id="main-content">
            
            <div class="top-bar">
                <div class="filter-group" style="flex: 1;">
                    <select id="filter-month" class="filter-select" onchange="app.filterData()"></select>
                    <select id="filter-type" class="filter-select" onchange="app.filterData()">
                        <option value="all">All Types</option>
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                    </select>
                    <select id="filter-category" class="filter-select" onchange="app.filterData()"></select>
                </div>
                
                <div class="filter-group">
                    <button class="btn btn-outline" onclick="app.resetFilters()" title="Reset Filters"><i class="fas fa-undo"></i></button>
                    <button class="btn btn-outline" onclick="app.exportPDF()" title="Export Report"><i class="fas fa-file-pdf"></i> Export</button>
                </div>
            </div>

            <div class="page-scroll">
                
                <div id="page-dashboard" class="page active">
                    <div class="kpi-row">
                        <div class="card">
                            <div class="kpi-label">Total Income</div>
                            <div class="kpi-number" style="color: var(--success);" id="kpi-income">0</div>
                            <div class="kpi-trend trend-up"><i class="fas fa-arrow-up"></i> Cash Inflow</div>
                        </div>
                        <div class="card">
                            <div class="kpi-label">Total Expense</div>
                            <div class="kpi-number" style="color: var(--danger);" id="kpi-expense">0</div>
                            <div class="kpi-trend trend-down"><i class="fas fa-arrow-down"></i> Cash Outflow</div>
                        </div>
                        <div class="card">
                            <div class="kpi-label">Net Savings</div>
                            <div class="kpi-number" style="color: var(--primary);" id="kpi-savings">0</div>
                            <div class="kpi-trend"><i class="fas fa-wallet"></i> Available</div>
                        </div>
                        <div class="card">
                            <div class="kpi-label">Budget Usage</div>
                            <div class="kpi-number" id="kpi-budget">0%</div>
                            <div class="kpi-trend"><i class="fas fa-chart-pie"></i> of Monthly Limit</div>
                        </div>
                    </div>

                    <div class="chart-row">
                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">Income vs Expense Trend</div>
                            </div>
                            <div id="chart-trend" style="height: 320px;"></div>
                        </div>
                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">By Category</div>
                            </div>
                            <div id="chart-donut" style="height: 320px;"></div>
                        </div>
                    </div>

                    <div class="chart-row">
                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">Budget vs Actual (Cumulative)</div>
                            </div>
                            <div id="chart-budget" style="height: 300px;"></div>
                        </div>
                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">Top Spending</div>
                            </div>
                            <div id="chart-bar" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <div id="page-add" class="page">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                        
                        <div class="card">
                            <h3 style="margin-bottom: 20px;">New Transaction</h3>
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <div><label style="font-size:12px; font-weight:600; color:var(--text-muted)">Date</label>
                                <input type="date" id="tx-date"></div>
                                
                                <div><label style="font-size:12px; font-weight:600; color:var(--text-muted)">Type</label>
                                <select id="tx-type"><option value="Expense">Expense</option><option value="Income">Income</option></select></div>
                                
                                <div><label style="font-size:12px; font-weight:600; color:var(--text-muted)">Category</label>
                                <input type="text" id="tx-category" list="cat-list" placeholder="e.g. Food, Salary">
                                <datalist id="cat-list"><option value="Food"><option value="Rent"><option value="Transport"><option value="Salary"></datalist></div>
                                
                                <div><label style="font-size:12px; font-weight:600; color:var(--text-muted)">Amount</label>
                                <input type="number" id="tx-amount" placeholder="0.00"></div>
                                
                                <button class="btn btn-primary" onclick="app.addTx()">Add Transaction</button>
                                
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="btn btn-outline" style="flex:1" onclick="app.genDemo()">Demo Data</button>
                                    <button class="btn btn-danger" onclick="app.clearData()"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="chart-header">
                                <div class="chart-title">Recent Activity</div>
                                <button class="btn btn-outline" style="font-size:12px; padding: 4px 8px;" onclick="app.exportCSV()">CSV</button>
                            </div>
                            <div class="table-wrapper">
                                <table id="tx-table">
                                    <thead><tr><th>Date</th><th>Category</th><th>Type</th><th>Amount</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="page">
                    <div class="card" style="max-width: 500px; margin: 0 auto;">
                        <h3 style="margin-bottom: 20px;">Preferences</h3>
                        <div style="display: flex; flex-direction: column; gap: 20px;">
                            <div>
                                <label style="font-size:14px; font-weight:600; display:block; margin-bottom: 8px;">Currency Symbol</label>
                                <select id="set-currency" onchange="app.saveSettings()">
                                    <option value="$">USD ($)</option>
                                    <option value="₫">VND (₫)</option>
                                    <option value="€">EUR (€)</option>
                                    <option value="£">GBP (£)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:14px; font-weight:600; display:block; margin-bottom: 8px;">Monthly Budget Target</label>
                                <input type="number" id="set-budget" onchange="app.saveSettings()">
                            </div>
                            <div style="padding: 16px; background: rgba(255,185,0,0.1); border-radius: 6px; border: 1px solid var(--warning);">
                                <i class="fas fa-info-circle" style="color: var(--warning);"></i> 
                                <span style="font-size: 13px;">Settings are saved automatically to your account.</span>
                            </div>
                        </div>
                    </div>
                </div>

            </div> </main>
        
        <nav id="bottom-nav">
            <div class="b-nav-item active" onclick="app.navigate('dashboard')"><i class="fas fa-home"></i></div>
            <div class="b-nav-item" onclick="app.navigate('add')"><i class="fas fa-plus-circle"></i></div>
            <div class="b-nav-item" onclick="app.navigate('settings')"><i class="fas fa-cog"></i></div>
        </nav>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDmV3I9ZQ-N866cZ5mzMhVLNHcKjfL8cQ0",
            authDomain: "financial-tracking-app-bb3cb.firebaseapp.com",
            databaseURL: "https://financial-tracking-app-bb3cb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "financial-tracking-app-bb3cb",
            storageBucket: "financial-tracking-app-bb3cb.firebasestorage.app",
            messagingSenderId: "242060161334",
            appId: "1:242060161334:web:e9a4e0c7f8758cd9770397",
            measurementId: "G-NV4B6CWRBS"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        const auth = getAuth(fApp);
        
        // GLOBAL APP CONTROLLER
        window.app = {
            user: null,
            data: [],
            settings: { currency: '₫', budget: 10000000 },
            filters: { month: 'all', type: 'all', category: 'all' },

            // --- NAVIGATION ---
            navigate: (pageId) => {
                document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
                document.getElementById('page-' + pageId).classList.add('active');
                
                // Update Menus
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.b-nav-item').forEach(el => el.classList.remove('active'));
                
                // Map index based on order
                const idx = ['dashboard', 'add', 'settings'].indexOf(pageId);
                if(idx !== -1) {
                    document.querySelectorAll('.nav-menu .nav-item')[idx].classList.add('active');
                    document.querySelectorAll('.b-nav-item')[idx].classList.add('active');
                }

                if(pageId === 'dashboard') setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
            },

            toggleTheme: () => {
                document.body.classList.toggle('dark-mode');
                app.renderCharts(); // Re-render for color
            },

            logout: () => signOut(auth),

            // --- DATA ACTIONS ---
            addTx: () => {
                const date = document.getElementById('tx-date').value;
                const type = document.getElementById('tx-type').value;
                const cat = document.getElementById('tx-category').value;
                const amt = parseFloat(document.getElementById('tx-amount').value);
                
                if(!date || !cat || isNaN(amt)) return alert("Please fill all fields properly.");
                
                push(ref(db, `users/${app.user.uid}/transactions`), {
                    date, type, category: cat, amount: amt
                });
                alert("Saved!");
                document.getElementById('tx-amount').value = '';
            },

            genDemo: () => {
                const cats = ['Food', 'Transport', 'Rent', 'Salary', 'Bonus', 'Utilities', 'Shopping'];
                for(let i=0; i<10; i++) {
                    const type = Math.random() > 0.4 ? 'Expense' : 'Income';
                    push(ref(db, `users/${app.user.uid}/transactions`), {
                        date: new Date().toISOString().split('T')[0],
                        type,
                        category: cats[Math.floor(Math.random() * cats.length)],
                        amount: Math.floor(Math.random() * 2000) + 100
                    });
                }
            },

            clearData: () => {
                if(confirm("Delete ALL data?")) set(ref(db, `users/${app.user.uid}/transactions`), null);
            },

            saveSettings: () => {
                app.settings.currency = document.getElementById('set-currency').value;
                app.settings.budget = parseFloat(document.getElementById('set-budget').value) || 0;
                localStorage.setItem('userSettings_' + app.user.uid, JSON.stringify(app.settings));
                app.updateUI();
            },

            // --- FILTERING ---
            filterData: () => {
                app.filters.month = document.getElementById('filter-month').value;
                app.filters.type = document.getElementById('filter-type').value;
                app.filters.category = document.getElementById('filter-category').value;
                app.updateUI();
            },

            resetFilters: () => {
                document.getElementById('filter-month').value = 'all';
                document.getElementById('filter-type').value = 'all';
                document.getElementById('filter-category').value = 'all';
                app.filterData();
            },

            getFiltered: () => {
                return app.data.filter(d => {
                    const mMatch = app.filters.month === 'all' || d.date.startsWith(app.filters.month);
                    const tMatch = app.filters.type === 'all' || d.type === app.filters.type;
                    const cMatch = app.filters.category === 'all' || d.category === app.filters.category;
                    return mMatch && tMatch && cMatch;
                });
            },

            // --- EXPORT ---
            exportPDF: () => {
                const el = document.getElementById('page-dashboard');
                html2canvas(el, { scale: 2, backgroundColor: document.body.classList.contains('dark-mode') ? '#121212' : '#f0f2f5' }).then(cvs => {
                    const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4');
                    const w = pdf.internal.pageSize.getWidth();
                    const h = (cvs.height * w) / cvs.width;
                    pdf.addImage(cvs.toDataURL('image/png'), 'PNG', 0, 0, w, h);
                    pdf.save('dashboard.pdf');
                });
            },

            exportCSV: () => {
                let csv = "Date,Type,Category,Amount\n";
                app.getFiltered().forEach(d => csv += `${d.date},${d.type},${d.category},${d.amount}\n`);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = 'data.csv'; a.click();
            },

            // --- RENDERERS ---
            updateUI: () => {
                // Populate Dropdowns if empty or data changed
                const months = [...new Set(app.data.map(d => d.date.substring(0,7)))].sort().reverse();
                const mSel = document.getElementById('filter-month');
                if(mSel.options.length <= 1) {
                    months.forEach(m => mSel.add(new Option(m, m)));
                }

                const cats = [...new Set(app.data.map(d => d.category))].sort();
                const cSel = document.getElementById('filter-category');
                if(cSel.options.length <= 1) {
                    cats.forEach(c => cSel.add(new Option(c, c)));
                }

                // Render
                app.renderKPIs();
                app.renderTable();
                app.renderCharts();
            },

            renderKPIs: () => {
                const data = app.getFiltered();
                const inc = data.filter(d=>d.type==='Income').reduce((s,x)=>s+x.amount,0);
                const exp = data.filter(d=>d.type==='Expense').reduce((s,x)=>s+x.amount,0);
                const cur = app.settings.currency;

                const animateValue = (id, start, end) => {
                    const el = document.getElementById(id);
                    el.innerText = cur + end.toLocaleString(); // Simplified for perf
                };

                animateValue('kpi-income', 0, inc);
                animateValue('kpi-expense', 0, exp);
                animateValue('kpi-savings', 0, inc - exp);
                
                const pct = app.settings.budget ? ((exp / app.settings.budget) * 100).toFixed(1) : 0;
                document.getElementById('kpi-budget').innerText = pct + "%";
            },

            renderTable: () => {
                const tbody = document.querySelector('#tx-table tbody');
                tbody.innerHTML = '';
                app.getFiltered().sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,10).forEach(d => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${d.date}</td>
                            <td>${d.category}</td>
                            <td><span style="color:${d.type==='Income'?'var(--success)':'var(--danger)'}bull; ${d.type}</span></td>
                            <td>${app.settings.currency}${d.amount.toLocaleString()}</td>
                        </tr>
                    `;
                });
            },

            renderCharts: () => {
                const data = app.getFiltered();
                const isDark = document.body.classList.contains('dark-mode');
                const textColor = isDark ? '#f3f2f1' : '#201f1e';
                const gridColor = isDark ? '#323130' : '#e1dfdd';
                
                const commonLayout = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { family: 'Segoe UI', color: textColor },
                    margin: { t: 20, l: 30, r: 10, b: 30 },
                    xaxis: { gridcolor: gridColor },
                    yaxis: { gridcolor: gridColor },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.2 }
                };

                // 1. Trend
                const dates = [...new Set(data.map(d=>d.date))].sort();
                const incS = dates.map(d => data.filter(x=>x.date===d && x.type==='Income').reduce((s,v)=>s+v.amount,0));
                const expS = dates.map(d => data.filter(x=>x.date===d && x.type==='Expense').reduce((s,v)=>s+v.amount,0));
                
                Plotly.react('chart-trend', [
                    { x: dates, y: incS, type: 'scatter', mode: 'lines', name: 'Income', line: {color: '#107c10', width: 3, shape: 'spline'} },
                    { x: dates, y: expS, type: 'scatter', mode: 'lines', name: 'Expense', line: {color: '#d13438', width: 3, shape: 'spline'} }
                ], commonLayout, {displayModeBar: false, responsive: true});

                // 2. Donut
                const expData = data.filter(d=>d.type==='Expense');
                const catMap = {}; expData.forEach(d => catMap[d.category] = (catMap[d.category]||0)+d.amount);
                Plotly.react('chart-donut', [{
                    labels: Object.keys(catMap), values: Object.values(catMap), type: 'pie', hole: 0.6,
                    marker: { colors: ['#0078d4', '#2b88d8', '#71afe5', '#deecf9', '#eff6fc'] }
                }], {...commonLayout, margin: {t:0,b:0,l:0,r:0}}, {displayModeBar: false, responsive: true});

                // 3. Budget Cumulative
                let cum = 0;
                const cumVals = dates.map(d => { cum += data.filter(x=>x.date===d && x.type==='Expense').reduce((s,v)=>s+v.amount,0); return cum; });
                const budgetLine = dates.map((_,i) => (app.settings.budget/30)*(i+1));
                
                Plotly.react('chart-budget', [
                    { x: dates, y: cumVals, type: 'scatter', fill: 'tozeroy', name: 'Actual', line: {color: '#0078d4'} },
                    { x: dates, y: budgetLine, type: 'scatter', mode: 'lines', name: 'Budget', line: {dash: 'dot', color: '#a19f9d'} }
                ], commonLayout, {displayModeBar: false, responsive: true});

                // 4. Bar
                const sorted = Object.entries(catMap).sort((a,b)=>b[1]-a[1]).slice(0,5);
                Plotly.react('chart-bar', [{
                    x: sorted.map(x=>x[1]), y: sorted.map(x=>x[0]), type: 'bar', orientation: 'h', marker: {color: '#0078d4'}
                }], commonLayout, {displayModeBar: false, responsive: true});
            }
        };

        // --- AUTH & INIT ---
        document.getElementById('btn-login-google').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        });

        onAuthStateChanged(auth, user => {
            const loadScreen = document.getElementById('loading-screen');
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app-container');

            if(user) {
                app.user = user;
                document.getElementById('user-name').innerText = user.displayName;
                document.getElementById('user-avatar').src = user.photoURL;
                
                // Load Settings
                const localSet = localStorage.getItem('userSettings_' + user.uid);
                if(localSet) app.settings = JSON.parse(localSet);
                document.getElementById('set-currency').value = app.settings.currency;
                document.getElementById('set-budget').value = app.settings.budget;

                // Load Data
                onValue(ref(db, `users/${user.uid}/transactions`), snap => {
                    const val = snap.val();
                    app.data = val ? Object.values(val) : [];
                    app.updateUI();
                    
                    // Transition
                    loadScreen.classList.add('hidden');
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    // Init Date Input
                    document.getElementById('tx-date').valueAsDate = new Date();
                });
            } else {
                app.user = null;
                appContainer.classList.add('hidden');
                loadScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
